from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import ContextTypes
from core.start import get_welcome_message

USER_LANGUAGES = {}


# ЁЯФШ START MENU BUTTONS
def get_start_buttons():
    keyboard = [
        [
            InlineKeyboardButton(
                "тЮХ Add me to a Group",
                url="https://t.me/ChatManageHelpbot?startgroup=true")
        ],
        [
            InlineKeyboardButton("ЁЯСе Group",
                                 url="https://t.me/GroupHelpChatGuard"),
            InlineKeyboardButton("ЁЯУв Channel",
                                 url="https://t.me/GroupHelpChatGuard")
        ],
        [
            InlineKeyboardButton("ЁЯТм Support",
                                 url="https://t.me/GroupHelpChatGuard"),
            InlineKeyboardButton("тД╣я╕П Information", callback_data="info")
        ],
        [
            InlineKeyboardButton("ЁЯМР ЁЯЗоЁЯЗ│ Languages",
                                 callback_data="language_menu")
        ], [InlineKeyboardButton("ЁЯЫа /help", callback_data="help_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)


# ЁЯФШ LANGUAGE BUTTONS
def get_language_buttons():
    keyboard = [[
        InlineKeyboardButton("ЁЯЗоЁЯЗ│ Hindi", callback_data="lang_hi"),
        InlineKeyboardButton("ЁЯЗмЁЯЗз English", callback_data="lang_en")
    ],
                [
                    InlineKeyboardButton("ЁЯЗ╡ЁЯЗ░ Urdu", callback_data="lang_ur"),
                    InlineKeyboardButton("ЁЯЗзЁЯЗй Bengali", callback_data="lang_bn")
                ],
                [
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Tamil", callback_data="lang_ta"),
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Telugu", callback_data="lang_te")
                ],
                [
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Marathi",
                                         callback_data="lang_mr"),
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Gujarati",
                                         callback_data="lang_gu")
                ],
                [
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Kannada",
                                         callback_data="lang_kn"),
                    InlineKeyboardButton("ЁЯЗоЁЯЗ│ Malayalam",
                                         callback_data="lang_ml")
                ],
                [InlineKeyboardButton("ЁЯФЩ Back", callback_data="start_menu")]]
    return InlineKeyboardMarkup(keyboard)


# ЁЯФШ HELP BUTTONS
def get_help_buttons():
    keyboard = [[
        InlineKeyboardButton("ЁЯУЦ Basic", callback_data="basic_cmds"),
        InlineKeyboardButton("ЁЯЫб Advanced", callback_data="adv_cmds")
    ],
                [
                    InlineKeyboardButton("ЁЯза Experts",
                                         callback_data="expert_cmds"),
                    InlineKeyboardButton("ЁЯУШ Pro Guide",
                                         callback_data="pro_cmds")
                ],
                [InlineKeyboardButton("ЁЯФЩ Back", callback_data="start_menu")]]
    return InlineKeyboardMarkup(keyboard)


# ЁЯФБ TRANSLATED WELCOME TEXT
def translate_welcome(user):
    lang = USER_LANGUAGES.get(user.id, "en")
    name = user.first_name if user else "Friend"

    if lang == "hi":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> рдЖрдкрдХреЗ рдЧреНрд░реБрдк рдХреЛ manage рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред\n\nЁЯСЙЁЯП╗ Supergroup рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ рдФрд░ Admin рдмрдирд╛рдПрдВред\n\nтЭУ <b>Commands рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП</b> /help рджрдмрд╛рдПрдБред"
    elif lang == "ur":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> ╪в┘╛ ┌й█Т ┌п╪▒┘И┘╛ ┌й┘И ╪в╪│╪з┘Ж█М ╪│█Т ┘Е┘Ж╪╕┘Е ┌й╪▒╪к╪з █Б█Т█Ф\n\nЁЯСЙЁЯП╗ ╪и╪▒╪з█Б ┌й╪▒┘Е ╪│┘╛╪▒┌п╪▒┘И┘╛ ┘Е█М┌║ ╪┤╪з┘Е┘Д ┌й╪▒█М┌║ ╪з┘И╪▒ ╪з█М┌И┘Е┘Ж ╪и┘Ж╪з╪ж█М┌║█Ф\n\nтЭУ /help ┌й┘Е╪з┘Ж┌И╪▓ ╪п█М┌й┌╛┘Ж█Т ┌й█Т ┘Д█М█Т ╪п╪и╪з╪ж█М┌║█Ф"
    elif lang == "bn":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> ржЖржкржирж╛рж░ ржЧрзНрж░рзБржк ржкрж░рж┐ржЪрж╛рж▓ржирж╛рзЯ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗред\n\nЁЯСЙЁЯП╗ рж╕рзБржкрж╛рж░ржЧрзНрж░рзБржкрзЗ ржпрзЛржЧ ржХрж░рзБржи ржПржмржВ ржЕрзНржпрж╛ржбржорж┐ржи ржХрж░рзБржиред\n\nтЭУ ржХржорж╛ржирзНржб ржжрзЗржЦрждрзЗ /help ржЪрж╛ржкрзБржиред"
    elif lang == "ta":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> роЙроЩрпНроХро│рпН роХрпБро┤рпБро╡рпИ роиро┐ро░рпНро╡роХро┐роХрпНроХ роЙродро╡рпБроХро┐ро▒родрпБ.\n\nЁЯСЙЁЯП╗ роЪрпБрокро░рпНроХрпБро░рпВрокрпНрокро┐ро▓рпН роЪрпЗро░рпНродрпНродрпБ роЕроЯрпНрооро┐ройрпН роЪрпЖропрпНропро╡рпБроорпН.\n\nтЭУ роХроЯрпНроЯро│рпИроХро│рпИ роХро╛рог /help роЕро┤рпБродрпНродро╡рпБроорпН."
    elif lang == "te":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> р░ор▒А р░Чр▒Нр░░р▒Вр░кр▒НтАМр░ир▒Б р░ир░┐р░░р▒Нр░╡р░╣р░┐р░Вр░Ър░бр░Вр░▓р▒Л р░╕р░╣р░╛р░пр░кр░бр▒Бр░др▒Бр░Вр░жр░┐.\n\nЁЯСЙЁЯП╗ р░╕р▒Вр░кр░░р▒НтАМр░Чр▒Нр░░р▒Вр░кр▒НтАМр░▓р▒Л р░Ьр▒Лр░бр░┐р░Вр░Ър░Вр░бр░┐ р░ор░░р░┐р░пр▒Б р░Ер░бр▒Нр░ор░┐р░ир▒НтАМр░Чр░╛ р░кр▒Нр░░р░ор▒Лр░Яр▒Н р░Ър▒Зр░пр░Вр░бр░┐.\n\nтЭУ р░Жр░жр▒Зр░╢р░╛р░▓р▒Б р░Ър▒Вр░бр░Яр░╛р░ир░┐р░Хр░┐ /help р░ир▒Кр░Хр▒Нр░Хр░Вр░бр░┐."
    elif lang == "mr":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> рддреБрдордЪреНрдпрд╛ рдЧреНрд░реБрдкрдЪреЗ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди рдХрд░рдгреНрдпрд╛рдд рдорджрдд рдХрд░рддреЛ.\n\nЁЯСЙЁЯП╗ рд╕реБрдкрд░рдЧреНрд░реБрдкрдордзреНрдпреЗ рдЬреЛрдбрд╛ рдЖрдгрд┐ рдЕтАНреЕрдбрдорд┐рди рдХрд░рд╛.\n\nтЭУ рдХрдорд╛рдВрдб рдкрд╛рд╣рдгреНрдпрд╛рд╕рд╛рдареА /help рджрд╛рдмрд╛."
    elif lang == "gu":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> ркдркорк╛рк░рк╛ ркЬрлВркеркирлЗ ркорлЗркирлЗркЬ ркХрк░рк╡рк╛ркорк╛ркВ ркоркжркж ркХрк░рлЗ ркЫрлЗ.\n\nЁЯСЙЁЯП╗ ркоркирлЗ рк╕рлБрккрк░ркЧрлНрк░рлБрккркорк╛ркВ ркЙркорлЗрк░рлЛ ркЕркирлЗ ркПркбркорк┐рки ркмркирк╛рк╡рлЛ.\n\nтЭУ /help ркжркмрк╛рк╡рлЛ ркЖркжрлЗрк╢рлЛ ркЬрлЛрк╡рк╛ ркорк╛ркЯрлЗ."
    elif lang == "kn":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> р▓ир▓┐р▓ор│Нр▓о р▓Чр│Бр▓Вр▓кр│Б р▓ир▓┐р▓░р│Нр▓╡р▓╣р▓┐р▓╕р▓▓р│Б р▓╕р▓╣р▓╛р▓п р▓ор▓╛р▓бр│Бр▓др│Нр▓др▓жр│Ж.\n\nЁЯСЙЁЯП╗ р▓ир▓ир│Нр▓ир▓ир│Нр▓ир│Б р▓╕р│Вр▓кр▓░р│Нр▓Чр│Нр▓░р│Вр▓кр│Нр▓ир▓▓р│Нр▓▓р▓┐ р▓╕р│Зр▓░р▓┐р▓╕р▓┐ р▓ор▓др│Нр▓др│Б р▓Жр▓бр│Нр▓ор▓┐р▓ир│Н р▓ор▓╛р▓бр▓┐.\n\nтЭУ р▓Жр▓Ьр│Нр▓Юр│Жр▓Чр▓│р▓ир│Нр▓ир▓╛р▓Чр│Ж р▓ир│Лр▓бр▓▓р│Б /help р▓Тр▓др│Нр▓др▓┐."
    elif lang == "ml":
        return f"ЁЯСЛ <b>Hi {name}!</b>\n\nЁЯдЦ <b>MarsGroup Bot</b> р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Бр┤Яр╡Ж р┤Чр╡Нр┤░р╡Вр┤кр╡Нр┤кр╡Н р┤▓р┤│р┤┐р┤др┤ор┤╛р┤пр┤┐ р┤ир┤┐р┤пр┤ир╡Нр┤др╡Нр┤░р┤┐р┤Хр╡Нр┤Хр┤╛р╡╗ р┤╕р┤╣р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр╡Бр┤ир╡Нр┤ир╡Б.\n\nЁЯСЙЁЯП╗ р┤Ор┤ир╡Нр┤ир╡Ж р┤╕р╡Вр┤кр╡Нр┤кр╡╝р┤Чр╡Нр┤░р╡Вр┤кр╡Нр┤кр┤┐р╡╜ р┤Ър╡Зр╡╝р┤Хр╡Нр┤Хр╡Бр┤Х, р┤Ер┤бр╡Нр┤ор┤┐р╡╗ р┤Жр┤Хр╡Нр┤Хр╡Бр┤Х.\n\nтЭУ /help р┤Ер┤ор╡╝р┤др╡Нр┤др┤┐ р┤Хр┤ор┤╛р╡╗р┤бр╡Бр┤Хр╡╛ р┤Хр┤╛р┤гр╡Бр┤Х."

    return get_welcome_message(user)


# ЁЯЫа SAFE EDIT FUNCTION
async def safe_edit(query, new_text, new_markup):
    try:
        current_text = (query.message.text or "").strip()
        new_text = new_text.strip()
        if current_text == new_text and query.message.reply_markup == new_markup:
            return
        await query.edit_message_text(text=new_text,
                                      reply_markup=new_markup,
                                      parse_mode="HTML")
    except Exception as e:
        print(f"тЭМ Failed to edit message: {e}")


# ЁЯУ▓ CALLBACK HANDLER
async def handle_button_click(update: Update,
                              context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await query.answer()

    if query.data == "start_menu":
        await safe_edit(query, translate_welcome(user), get_start_buttons())

    elif query.data == "language_menu":
        await safe_edit(query, "ЁЯМР <b>Select your language:</b>",
                        get_language_buttons())

    elif query.data.startswith("lang_"):
        lang_code = query.data.split("_")[1]
        USER_LANGUAGES[user.id] = lang_code
        await safe_edit(query, translate_welcome(user), get_start_buttons())

    elif query.data == "help_menu":
        await safe_edit(query, "ЁЯза <b>Help Menu</b>\nChoose an option below:",
                        get_help_buttons())

    elif query.data == "basic_cmds":
        await safe_edit(
            query, "<b>ЁЯУЦ Basic Commands</b>\n\n"
            "ЁЯСоЁЯП╗ /reload - Updates admin list\n"
            "ЁЯХ╡ЁЯП╗ /settings - Manage group settings\n"
            "ЁЯСоЁЯП╗ /ban - Ban user permanently\n"
            "ЁЯСоЁЯП╗ /mute - Mute user\n"
            "ЁЯСоЁЯП╗ /kick - Kick user\n"
            "ЁЯСоЁЯП╗ /unban - Unban user\n"
            "ЁЯСоЁЯП╗ /info - Show user info\n"
            "ЁЯСоЁЯП╗ /infopvt - Info in private\n"
            "тЧ╜я╕П /staff - Show group staff list", get_help_buttons())

    elif query.data == "adv_cmds":
        await safe_edit(
            query, "<b>ЁЯЫб Advanced Commands</b>\n\n"
            "ЁЯФР /lock - Lock content\n"
            "ЁЯФУ /unlock - Unlock\n"
            "ЁЯУЫ /purge - Bulk delete\n"
            "ЁЯУН /setwelcome - Custom welcome\n"
            "ЁЯОЙ /cleanwelcome - Auto delete welcome\n"
            "ЁЯФЧ /antilink - Enable anti-link", get_help_buttons())

    elif query.data == "expert_cmds":
        await safe_edit(
            query, "<b>ЁЯза Expert Commands</b>\n\n"
            "ЁЯз╛ /log - Send logs\n"
            "ЁЯУК /stats - Bot stats\n"
            "ЁЯз╣ /cleandb - Clean DB\n"
            "ЁЯФз /maintenance - Maintenance mode\n"
            "ЁЯЫа /module - Enable/disable modules", get_help_buttons())

    elif query.data == "pro_cmds":
        await safe_edit(
            query, "<b>ЁЯУШ Pro Guide</b>\n\n"
            "ЁЯЪА Full guide:\n"
            "<a href='https://github.com/ravinishayar/marsChatBot'>marsChatBot Repo</a>\n\n"
            "ЁЯзСтАНЁЯТ╗ Contact: @ravinishayar54", get_help_buttons())

    elif query.data == "info":
        await safe_edit(
            query, "<b>тД╣я╕П Group Help (ChatGuard)</b>\n"
            "Developed by <a href='https://t.me/ravinishayar54'>@ravinishayar54</a>, and it is actively maintained.\n"
            "Launched in <b>2025</b> and updated regularly.\n\n"
            "<b>ЁЯдЦ Bot Version:</b> 2.0\n\n"
            "<b>ЁЯСд Bot Admins:</b>\n"
            "тАв Created by <b>Karan</b> (ЁЯСЙ <a href='https://t.me/ravinishayar54'>@ravinishayar54</a>)\n"
            "тАв Deployment and Management by <b>Villain</b> (ЁЯСЙ <a href='https://t.me/iamakki001'>@iamakki001</a>)\n"
            "тАв Concept and Idea by the Developer\n\n"
            "тЪая╕П <b>This bot does not support any kind of promotion.</b>\n"
            "Its purpose is to <b>help manage your group automatically</b>.\n"
            "Just add the bot and promote it as admin тАФ it will handle everything on its own!",
            get_start_buttons())
